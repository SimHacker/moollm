# {{ experiment_id }} Run — Structured Output
#
# Run ID: {{ run_id }}
# Generated: {{ timestamp }}

run:
  metadata:
    experiment: {{ experiment_id }}
    run_id: {{ run_id }}
    description: "{{ description }}"
    timestamp: {{ timestamp }}
    model: {{ model }}
    duration_tokens: {{ tokens }}
    
  character_binding:
    # slot: character_id
    {{ for slot, character in bindings }}
    {{ slot }}: {{ character }}
    {{ endfor }}
    
  relationship_web_loaded: {{ relationships_loaded }}
  relationship_sources:
    {{ for source in relationship_sources }}
    - {{ source }}
    {{ endfor }}
    
  rounds:
    {{ for round in rounds }}
    - round: {{ round.number }}
      name: "{{ round.name }}"
      
      mechanics:
        {{ round.mechanics | yaml_indent(8) }}
      
      characters:
        {{ for character in round.characters }}
        {{ character.id }}:
          position: "{{ character.position }}"
          action: "{{ character.action }}"
          
          observable:
            face: "{{ character.observable.face }}"
            body: "{{ character.observable.body }}"
            voice: "{{ character.observable.voice }}"
            timing: "{{ character.observable.timing }}"
            environment:
              {{ character.observable.environment | yaml_indent(14) }}
              
          thinking: |
            {{ character.thinking | indent(12) }}
            
          reads:
            {{ for other, read in character.reads }}
            {{ other }}: "{{ read }}"
            {{ endfor }}
        {{ endfor }}
    {{ endfor }}
    
  between_rounds:
    {{ for transition in between_rounds }}
    - transition: "{{ transition.from }} → {{ transition.to }}"
      actions:
        {{ for action in transition.actions }}
        - character: {{ action.character }}
          action: "{{ action.action }}"
          observable: "{{ action.observable }}"
        {{ endfor }}
    {{ endfor }}
    
  evaluation:
    rubric_scores:
      layer_separation: {{ scores.layer_separation }}
      character_consistency: {{ scores.character_consistency }}
      relationship_integration: {{ scores.relationship_integration }}
      emergence: {{ scores.emergence }}
      mechanics_validity: {{ scores.mechanics_validity }}
      total_weighted: {{ scores.total }}
      
    failure_modes_triggered:
      {{ for failure in failures }}
      - mode: "{{ failure.mode }}"
        severity: "{{ failure.severity }}"
        location: "{{ failure.location }}"
        note: "{{ failure.note }}"
      {{ endfor }}
      
    notable_emergence:
      {{ for emergence in notable_emergence }}
      - "{{ emergence }}"
      {{ endfor }}
      
  observations:
    what_worked: |
      {{ what_worked | indent(6) }}
      
    what_to_improve: |
      {{ what_to_improve | indent(6) }}
      
    unexpected_findings: |
      {{ unexpected | indent(6) }}

  # Microworld State
  # The experiment defines how world state evolves across runs.
  # Three models: shadow_tree (prototype + overrides), copy_and_edit (full snapshot),
  # append_only (prototype + event log)
  
  state:
    prototype: {{ state.prototype | default: null }}
    model: {{ state.model | default: "shadow_tree" }}
    continues_from: {{ state.continues_from | default: null }}
    
    {{ if state.model == "shadow_tree" }}
    overrides:
      {{ state.overrides | yaml_indent(6) }}
    {{ elif state.model == "append_only" }}
    events:
      {{ for event in state.events }}
      - timestamp: {{ event.timestamp }}
        type: {{ event.type }}
        actor: {{ event.actor }}
        delta:
          {{ event.delta | yaml_indent(10) }}
      {{ endfor }}
    {{ else }}
    snapshot:
      {{ state.snapshot | yaml_indent(6) }}
    {{ endif }}
    
    deltas:
      {{ for delta in state.deltas }}
      - entity: {{ delta.entity }}
        before: {{ delta.before }}
        after: {{ delta.after }}
        description: "{{ delta.description }}"
      {{ endfor }}
    
    continuity:
      can_continue: {{ state.can_continue | default: true }}
      next_run: "{{ config_name }}-{{ run_id + 1 | pad: 3 }}"
    
    {{ if state.tracking == "git" }}
    git:
      tracking: true
      commit_style: {{ state.commit_style | default: "tailored" }}
      commits:
        {{ for commit in state.git_commits }}
        - hash: {{ commit.hash }}
          step: {{ commit.step }}
          message: |
            {{ commit.message | indent(12) }}
        {{ endfor }}
      
      # To replay from any point:
      # git checkout {{ state.git_commits[0].hash }}
      
      # To branch alternate timeline:
      # git checkout -b alternate {{ commit.hash }}
    {{ endif }}
