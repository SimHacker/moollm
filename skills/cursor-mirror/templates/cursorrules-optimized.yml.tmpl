# CURSORRULES OPTIMIZATION TEMPLATE
# cursor-mirror optimize-cursorrules
#
# This template generates an optimized .cursorrules file from the current
# MOOLLM repo state. User-added content outside the markers is preserved.

# MARKERS — Always respect these when parsing existing .cursorrules
markers:
  begin: "# === MOOLLM CURSOR-MIRROR BEGIN ==="
  end: "# === MOOLLM CURSOR-MIRROR END ==="
  warning: "# DO NOT EDIT BETWEEN MARKERS — regenerated by cursor-mirror optimize-cursorrules"

# GENERATION SOURCES — What to scan to build optimized rules
sources:
  
  # Core index
  skill_index:
    path: "skills/INDEX.yml"
    extract: "skill names, paths, protocols, k-lines"
    
  # Kernel files
  kernel:
    paths:
      - "kernel/drivers/cursor.yml"
      - "kernel/NAMING.yml"
      - "kernel/INTEREST-GATES.yml"
    extract: "boot sequence, driver config, naming conventions"
    
  # Key ambient skills
  ambient_skills:
    paths:
      - "skills/no-ai-slop/CARD.yml"
      - "skills/no-ai-gloss/CARD.yml"
      - "skills/yaml-jazz/CARD.yml"
      - "skills/postel/CARD.yml"
    extract: "ambient hygiene rules"
    
  # Hot skills — most frequently used
  hot_skills:
    detect_from: ".moollm/hot.yml"
    fallback:
      - bootstrap
      - moollm
      - skill
      - adventure
      - character

# OUTPUT TEMPLATE — The generated .cursorrules content
output_template: |
  # === MOOLLM CURSOR-MIRROR BEGIN ===
  # DO NOT EDIT BETWEEN MARKERS — regenerated by cursor-mirror optimize-cursorrules
  # Generated: {{ timestamp }}
  # Repo: {{ repo_path }}
  # Commit: {{ git_commit_short }}
  
  # MOOLLM Mini Kernel for Cursor
  # Keep tight; pointers only. No placeholders.
  
  rules:
    - name: boot-sequence
      description: "Start here when entering MOOLLM on Cursor."
      steps:
        - "Read kernel/drivers/cursor.yml for Cursor-specific mode."
        - "Read skills/INDEX.yml for skill navigation."
        - "Read skills/bootstrap/CARD.yml for session warmup."
  
    - name: skill-reading-order
      description: "Efficient skill reading."
      order:
        - "CARD.yml → interface sniff"
        - "SKILL.md → protocol details"
        - "README.md → deep context only if needed"
  
    - name: yaml-jazz
      description: "Comments are semantic data for the LLM."
      principles:
        - "# Comments carry meaning — read them"
        - "Structure implies relationship"
        - "Directories are expandable outlines"
        - "Filenames are K-lines (semantic triggers)"
  
    - name: no-ai-slop
      description: "AMBIENT — always active hygiene."
      avoid:
        - "Verbosity — 50 words when 5 would do"
        - "Hallucination — making up facts"
        - "ASCII borders in comments — decoration not data"
        - "Filler phrases — 'I think', 'It seems'"
  
    - name: hierarchical-skills
      description: "Skills can contain instances and runs."
      pattern: "skills/experiment/experiments/name/runs/run-name/RUN-NNN.yml"
      principle: "The path IS the context"
  
  tools:
    - name: cursor-mirror
      path: skills/cursor-mirror/scripts/cursor_mirror.py
      invoke: "python3 skills/cursor-mirror/scripts/cursor_mirror.py <command>"
      key_commands:
        - "status                   # quick health check"
        - "tree                     # navigate workspaces/composers"
        - "tail --limit 50          # recent messages"
        - "optimize-cursorrules     # regenerate this file"
  
  key_skills:
  {{ key_skills_yaml }}
  
  # Generated from skills/INDEX.yml — {{ skill_count }} skills indexed
  skill_index: skills/INDEX.yml
  
  # === MOOLLM CURSOR-MIRROR END ===

# MERGE ALGORITHM — How to combine with existing user content
merge:
  strategy: |
    1. Read existing .cursorrules
    2. Find MOOLLM markers (begin/end)
    3. Extract content BEFORE begin marker (user prefix)
    4. Extract content AFTER end marker (user suffix)
    5. Generate new MOOLLM section from template
    6. Concatenate: user_prefix + moollm_section + user_suffix
    7. Write result
    
  if_no_markers: |
    If existing file has no markers:
    - Warn user
    - Prepend generated content with markers
    - Append existing content as user suffix
    - Suggest user review and reorganize

# INVOCATION PROTOCOL
protocol: |
  1. cursor-mirror optimize-cursorrules
     → Scans current repo, generates to .cursorrules
     
  2. cursor-mirror optimize-cursorrules --output .cursorrules.new
     → Generates to alternate file for review
     
  3. cursor-mirror optimize-cursorrules --repo /path/to/moollm
     → Generates from specified repo
