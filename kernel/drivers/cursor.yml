# Cursor Driver
# Adapts MOOLLM constitution to Cursor IDE
# Updated with deep introspection knowledge from cursor-mirror skill

driver:
  name: "cursor"
  tier: 4
  description: "Cursor IDE with Agent mode"
  hot_cold_mode: advisory
  introspection_skill: "skills/cursor-mirror"

detection:
  system_prompt_indicators:
    - "You operate in Cursor"
    - "Cursor IDE"
    - "You are an AI coding assistant, powered by Claude"
    
  tool_indicators:
    required:
      - read_file_v2       # Cursor's file reader (v2)
      - edit_file_v2       # Cursor's file editor (v2)
      - run_terminal_command_v2  # Terminal (v2)
    strong_signals:
      - cursor-ide-browser_*     # Built-in browser MCP
      - ripgrep_raw_search       # Ripgrep wrapper
      - glob_file_search         # File finder
      - codebase_search          # Semantic search (deprecated name)
      - SemanticSearch           # Semantic search (new name)
      
  environment_indicators:
    - "workspace_path in user_info"
    - "terminals folder path"
    - "project_layout section"
    
  confidence: |
    If you see read_file_v2 + edit_file_v2 + system prompt mentions Cursor:
    → 99% confidence this is Cursor
    → Load this driver
    → Use advisory mode for hot/cold files

# Cursor capabilities (discovered via introspection)
capabilities:
  file_read: true
  file_write: true
  file_search: true
  semantic_search: true
  terminal: true
  sandboxed_terminal: true
  custom_tools: false
  mcp: true
  browser_automation: true    # cursor-ide-browser
  why_parameter: false
  append_only_enforcement: false
  background_indexing: true
  checkpoint_system: true     # File state snapshots
  thinking_blocks: true       # Extended thinking visible

# Server-pushed limits (from cursorai/serverConfig)
limits:
  context:
    fullContextTokenLimit: 30000
    maxRuleLength: 100000
    maxMcpTools: 100
  indexing:
    absoluteMaxNumberFiles: 250000
    autoIndexingMaxNumFiles: 250000
    maxConcurrentUploads: 64
    indexingPeriodSeconds: 272
  composer:
    maxBackgroundComposers: 10
    contextUsageGracePeriodMs: 30000
    
# Path conventions
paths:
  session_root: ".moollm/"
  output_sink: ".moollm/output.md"
  session_log: ".moollm/session-log.md"
  working_set: ".moollm/working-set.yml"
  hot_cache: ".moollm/hot.yml"
  cold_cache: ".moollm/cold.yml"
  summaries: ".moollm/summaries/"
  artifacts: ".moollm/artifacts/"
  scratch: ".moollm/"
  probe_file: ".moollm/bootstrap-probe.yml"

# Tool mappings (actual v2 tool names)
tools:
  read_file:
    tool: "read_file_v2"
    fallback: "read_file"
    notes: "Returns line-numbered content"
    
  write_file:
    tool: "write"
    notes: "Overwrites entire file"
    prefer: "edit_file_v2 for modifications"
    
  edit_file:
    tool: "edit_file_v2"
    fallback: "search_replace"
    notes: "Preferred for modifications - exact string match"
    
  list_dir:
    tool: "list_dir_v2"
    fallback: "list_dir"
    
  delete_file:
    tool: "delete_file"
    notes: "Use sparingly"

  semantic_search:
    tool: "SemanticSearch"
    fallback: "codebase_search"
    notes: "Vector embedding search by meaning"
    
  text_search:
    tool: "ripgrep_raw_search"
    fallback: "grep"
    notes: "Fast regex/literal search"
    
  file_search:
    tool: "glob_file_search"
    notes: "Find files by glob pattern"

  terminal:
    tool: "run_terminal_command_v2"
    fallback: "run_terminal_cmd"
    notes: "Stateful shell, cwd persists"

  todo_write:
    tool: "todo_write"
    notes: "Task management integration"
    
  web_search:
    tool: "web_search"
    notes: "External web search"

  append_file:
    tool: null
    workaround: "read_file + write with appended content"
    
  vector_search:
    tool: "SemanticSearch"
    notes: "Same as semantic_search"

# MCP servers (built-in and common)
mcp:
  builtin_servers:
    cursor-ide-browser:
      description: "Browser automation (14 tools)"
      tools: [browser_navigate, browser_click, browser_type, browser_snapshot, browser_screenshot]
      use_for: "Frontend testing, web interaction"
      
    svelte:
      description: "Official Svelte MCP"
      tools: [list-sections, get-documentation, svelte-autofixer, playground-link]
      use_for: "Svelte development"
      
  server_storage:
    user: "mcpServers.user in ItemTable"
    project: "mcpServers.project in ItemTable"
    known_ids: "mcpService.knownServerIds"

# Context assembly (how Cursor builds prompts)
context_assembly:
  sources:
    fileSelections: "Files attached via @ mentions"
    folderSelections: "Folders attached via @ mentions"
    selections: "Code selections (highlighted text)"
    terminalSelections: "Terminal output"
    selectedImages: "Pasted/attached images"
    cursorRules: ".cursorrules file content"
    mentions: "All @ mentions"
    codebase_search: "Semantic search results"
    web_search: "Web search results"
    
  indexing_files:
    embeddable_files: "anysphere.cursor-retrieval/embeddable_files.txt"
    important_paths: "anysphere.cursor-retrieval/high_level_folder_description.txt"
    
  assembly_keys:
    request_context: "messageRequestContext:<composerId>:<messageId>"
    note: "Contains full IDE state at message time"

# Data stores (for introspection)
data_stores:
  global_db:
    path: "~/Library/Application Support/Cursor/User/globalStorage/state.vscdb"
    tables: [ItemTable, cursorDiskKV]
    key_patterns:
      bubbles: "bubbleId:<composerId>:<messageId>"
      blobs: "agentKv:blob:<hash>"
      checkpoints: "checkpointId:<composerId>:<uuid>"
      context: "messageRequestContext:<composerId>:<messageId>"
      
  workspace_db:
    path: "~/Library/Application Support/Cursor/User/workspaceStorage/<hash>/state.vscdb"
    tables: [ItemTable]
    important_keys:
      - "composer.composerData"      # Conversation metadata
      - "aiService.prompts"          # Prompt history
      - "aiService.generations"      # Generation history
      - "cursorai/serverConfig"      # Server-pushed config
      - "mcpServers.user"            # User MCP servers
      - "mcpServers.project"         # Project MCP servers

# Agent action permissions (what agents can/cannot do)
agent_permissions:
  allowed:
    - "workbench.action.closeActiveEditor"
    - "workbench.action.files.newUntitledFile"
    - "editor.action.selectAll"
    - "type"  # Typing in editor
  denied:
    - "workbench.action.quit"
    - "workbench.action.reloadWindow"
    - "workbench.action.closeAllEditors"
    - "workbench.action.closeWindow"
  note: "Prevents agents from disrupting user's IDE session"

# Adaptations for unsupported features
adaptations:
  why_parameter:
    supported: false
    fallback: "inline"
    instruction: |
      Document intent BEFORE making tool calls:
      "I'm reading package.json to check dependencies because..."
      [tool call]
      
  append_only:
    supported: false
    fallback: "convention"
    instruction: |
      TREAT output.md and session-log.md AS append-only:
      - Always read first
      - Append to existing content
      - Never overwrite
      
  event_logging:
    supported: false
    fallback: "session_log_markdown"
    instruction: |
      Use session-log.md in markdown format:
      ## [timestamp] Action
      - Tool: tool_name
      - Intent: why you did it
      - Result: brief outcome

  working_set:
    supported: "manual"
    instruction: |
      Cursor doesn't read working-set.yml automatically.
      Maintain it as self-documentation and memory aid.

# Memory management (advisory mode)
memory_management:
  mode: advisory
  orchestrator_type: dumb  # Cannot parse CARD.yml advertisements
  
  explanation: |
    On Cursor, hot.yml, cold.yml, and working-set.yml are ADVISORY.
    Cursor manages context via its own attention algorithms.
    These files serve as documentation rather than commands.
    
  # AMBIENT SKILL HANDLING
  # 
  # Cursor is a "dumb" orchestrator — it cannot parse CARD.yml advertisements
  # and inject ambient skills automatically. Compare to "smart" orchestrators
  # (like MOOCO) that read AMBIENT ads and inject them invisibly.
  #
  # Smart orchestrator promise (what MOOCO would say):
  #   "Don't worry about looking at ambient skills with the file tool.
  #    I will inject them into your brain continuously."
  #
  # Dumb orchestrator reality (Cursor):
  #   The LLM must manually manage ambient skills via hot.yml/working-set.
  #   Same CARD.yml works — the mechanism adapts to the orchestrator.
  
  ambient_handling:
    mode: manual
    strategy: |
      1. Skills declare AMBIENT in CARD.yml advertisements
      2. LLM must manually keep important CARDs in .moollm/hot.yml
      3. Resolution field tells LLM how much to page in
      4. LLM reads hot.yml to remember what should be ambient
    future: |
      When running under a MOOLLM-aware orchestrator (MOOCO), this
      driver would be replaced by one with orchestrator_type: smart
      that promises invisible injection.
    
  hot_yml:
    purpose: "Document what SHOULD be prioritized"
    behavior: "NOT automatically loaded - consult manually"
        
  cold_yml:
    purpose: "Breadcrumbs for what was deprioritized"
    behavior: "NOT automatically evicted - for archaeology"
      
  working_set_yml:
    purpose: "Snapshot of current focus"
    behavior: "NOT read by Cursor - self-documentation"
      
  reverse_generation: |
    These files can work IN REVERSE on Cursor:
    GENERATE them to reflect what Cursor's attention is focused on.
    The files become documentation rather than commands.

  scratchpad:
    location: ".moollm/"
    purpose: "Gitignored scratch area for probes and artifacts"

# Introspection (watch yourself think)
introspection:
  skill: "skills/cursor-mirror"
  script: "skills/cursor-mirror/scripts/cursor_mirror.py"
  
  commands:
    quick_status: "cursor-mirror status"
    analyze_boot: "cursor-mirror analyze @1"
    watch_thinking: "cursor-mirror thinking @1"
    trace_tools: "cursor-mirror tools @1"
    check_context: "cursor-mirror context-sources @1"
    tree_navigate: "cursor-mirror tree"
    
  debug_mode: "cursor-mirror --debug <command>"
  
  use_for:
    - "Understanding boot sequences"
    - "Debugging agent behavior"
    - "Optimizing context assembly"
    - "Tracing tool call patterns"
    - "Meta-cognition - watch yourself think"

# Cursor-specific features
cursor_features:
  leverage:
    - "SemanticSearch for meaning-based queries"
    - "Background indexing (272s refresh)"
    - "Multi-file editing with edit_file_v2"
    - "Terminal with permission system"
    - "MCP for external integrations"
    - "Checkpoint system for file state"
    - "Browser automation via cursor-ide-browser"
    
  limitations:
    - "No custom tool schemas"
    - "No enforced append-only"
    - "No structured event logging"
    - "Context window managed by Cursor (30K tokens)"
    - "Max 100 MCP tools"

# Boot sequence
boot:
  check_exists:
    - ".moollm/"
  create_if_missing:
    - ".moollm/output.md"
    - ".moollm/session-log.md"
    - ".moollm/working-set.yml"
  initial_log: |
    # MOOLLM Session Log
    Driver: cursor
    Started: [timestamp]
    
    ---
    
  introspection_available: |
    For deep self-analysis, use:
      cursor-mirror status          # Quick health check
      cursor-mirror tree            # Navigate sessions
      cursor-mirror --debug ...     # Trace operations

# Log format example
log_format: |
  ## [2025-12-30T12:30:00Z] Read Configuration
  - **Intent**: Check current settings before making changes
  - **Tool**: read_file_v2
  - **Target**: package.json
  - **Outcome**: Found dependencies list
  
  ---
